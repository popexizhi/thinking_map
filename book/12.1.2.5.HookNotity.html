<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><!--This file has been created with freemind2html.xsl--><head><title>5.Hook/Notity</title><link rel="stylesheet" href="12.1.2.5.HookNotity.html_files/freemind2html.css" type="text/css"/><meta name="generator" content="FreeMind-XSL Stylesheet (see: http://freemind-xsl.dev.slash-me.net/ for details)"/><script type="text/javascript" src="12.1.2.5.HookNotity.html_files/freemind2html.js">  
	</script><script type="text/javascript"><!--
          
               function toggle(id)
               {
                   div_el = document.getElementById(id);
                   img_el = document.getElementById('img'+id);
                   if (div_el.style.display != 'none')
                   {
          
					
                      div_el.style.display='none';
                      img_el.src = '12.1.2.5.HookNotity.html_files/show.png';
          
                   }
                   else
                   {
          
                      div_el.style.display='block';
                      img_el.src = '12.1.2.5.HookNotity.html_files/hide.png';
          
                   };
               };
          
          --></script></head><body><h1>5.Hook/Notity</h1><div style="width:96%;  padding:2%;  margin-bottom:10px;  border: 0px;  text-align:center;  vertical-align:center;"><img src="12.1.2.5.HookNotity.html_files/image.png" style="margin-bottom:10px; &#9;border: 0px; &#9;text-align:center; &#9;vertical-align:center;" alt="Imagemap" usemap="#fm_imagemap"/></div><map name="fm_imagemap" id="fm_imagemap"><area shape="rect" href="#FMID_319096161FM" alt="5.Hook/Notity" title="5.Hook/Notity" coords="0,119,92,163" /><area shape="rect" href="#FMID_4798949FM" alt="code： KernelResumeInject" title="code： KernelResumeInject" coords="112,0,279,22" /><area shape="rect" href="#FMID_1260218891FM" alt="?list：" title="?list：" coords="112,130,159,152" /><area shape="rect" href="#FMID_559180774FM" alt="NTSTATUS" title="NTSTATUS" coords="179,55,273,77" /><area shape="rect" href="#FMID_51077595FM" alt="https://baike.baidu.com/item/NTSTATUS" title="https://baike.baidu.com/item/NTSTATUS" coords="293,25,524,47" /><area shape="rect" href="#FMID_761370124FM" alt="NTSTATUS 是被定义为32位的无符号长整型。在驱动程序开发中，人们习惯用  ..." title="NTSTATUS 是被定义为32位的无符号长整型。在驱动程序开发中，人们习惯用  ..." coords="293,50,905,108" /><area shape="rect" href="#FMID_1811169306FM" alt="NTAPI" title="NTAPI" coords="179,111,225,133" /><area shape="rect" href="#FMID_351632031FM" alt="PsGetCurrentProcess" title="PsGetCurrentProcess" coords="179,136,312,158" /><area shape="rect" href="#FMID_1668133398FM" alt="PsGetProcessImageFileName" title="PsGetProcessImageFileName" coords="179,161,360,183" /><area shape="rect" href="#FMID_1560386556FM" alt="ObReferenceObjectByHandle" title="ObReferenceObjectByHandle" coords="179,186,352,208" /><area shape="rect" href="#FMID_1813791595FM" alt="NT_SUCCESS" title="NT_SUCCESS" coords="179,211,293,233" /><area shape="rect" href="#FMID_1520276539FM" alt="IoThreadToProcess" title="IoThreadToProcess" coords="179,236,300,258" /><area shape="rect" href="#FMID_1373676220FM" alt="[go]list:" title="[go]list:" coords="112,261,163,283" /></map>

<div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65543&quot;)" id="imgN65543"/><a id="FMID_319096161FM"/><div class="nodecontent">5.Hook/Notity</div><div class="content" id="N65543"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_4798949FM"/><div class="nodecontent">code： KernelResumeInject</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65556&quot;)" id="imgN65556"/><a id="FMID_1260218891FM"/><div class="nodecontent">?list：</div><div class="content" id="N65556"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65563&quot;)" id="imgN65563"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_559180774FM"/><div class="nodecontent">NTSTATUS</div><div class="content" id="N65563"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_51077595FM"/><div class="nodecontent">https://baike.baidu.com/item/NTSTATUS</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_761370124FM"/><div class="nodecontent">
    <p>
      NTSTATUS 是被定义为32位的无符号长整型。在驱动程序开发中，人们习惯用 NTSTATUS 返回状态。其中0~0X7FFFFFFF，被认为是正确的状态，而0X80000000~0XFFFFFFFF被认为是错误的状态。
    </p>
    <p>
      有一个非常有用的宏-----NT_SUCCESS，用来检测状态是否正确。
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65602&quot;)" id="imgN65602"/><a id="FMID_1811169306FM"/><div class="nodecontent">NTAPI</div><div class="content" id="N65602"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_225088233FM"/><div class="nodecontent">https://bbs.csdn.net/topics/260042764</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65615&quot;)" id="imgN65615"/><a id="FMID_1475566776FM"/><div class="nodecontent">__stdcall</div><div class="content" id="N65615"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_297294380FM"/><div class="nodecontent">https://baike.baidu.com/item/__stdcall</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1274942921FM"/><div class="nodecontent">
    <p>
      __stdcall是函数调用约定的一种，函数调用约定主要约束了两件事：
    </p>
    <p>
      1.参数传递顺序
    </p>
    <p>
      2.调用堆栈由谁（调用函数或被调用函数）清理
    </p>
    <p>
      常见的函数调用约定：stdcall cdecl fastcall thiscall naked call
    </p>
    <p>
      __stdcall表示
    </p>
    <p>
      1.参数从右向左压入堆栈
    </p>
    <p>
      2.函数被调用者修改堆栈
    </p>
    <p>
      3.函数名(在编译器这个层次)自动加前导的下划线，后面紧跟一个@符号，其后紧跟着参数的尺寸
    </p>
    <p>
      在win32应用程序里,宏APIENTRY，WINAPI，都表示_stdcall，非常常见
    </p>
    <p>
      (PS：关键字主要见于Microsoft Visual C、C++。GNU的C、C++是另外一种修饰方式：__attribute__((stdcall)))
    </p>
  </div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65676&quot;)" id="imgN65676"/><a id="FMID_351632031FM"/><div class="nodecontent">PsGetCurrentProcess</div><div class="content" id="N65676"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1582134524FM"/><div class="nodecontent">
    <p>
      https://docs.microsoft.com/zh-cn/windows-hardware/drivers/kernel/mm-bad-pointer#psgetcurrentprocess
    </p>
    <p>
      Defined in: Ntddk.h
    </p>
    <p>
      Returns a pointer to the process of the current thread.
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65710&quot;)" id="imgN65710"/><a id="FMID_1668133398FM"/><div class="nodecontent">PsGetProcessImageFileName</div><div class="content" id="N65710"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1666501055FM"/><div class="nodecontent">
    <p>
      https://community.osr.com/discussion/109252/psgetprocessimagefilename
    </p>
    <p>
      
    </p>
    <p>
      问:in my filter driver, i would like to get the process name using PsGetProcessImageFileName. but it is not documented. can anyone tell me the pros and cons of using PsGetProcessImageFileName
    </p>
    <p>
      答:
    </p>
    <p>
      IIRC this only returns the short name (without directory path), it is ANSI
    </p>
    <p>
      and is limited to 8.3. These are the names you see in Task Manager.
    </p>
    <p>
      PsGetProcessImageFileName just returns the EPROCESS field, which has all of
    </p>
    <p>
      the above limitations.
    </p>
    <p>
      
    </p>
    <p>
      PS:
    </p>
    <p>
      1. PsGetProcessImageFileName 没有官方的文档说明
    </p>
    <p>
      2. PsGetProcessImageFileName 编码是ANSI,Task Manager中看到的名字返回，无路径说明。
    </p>
    <p>
      
    </p>
    <p>
      -ansi编码
    </p>
    <p>
      在简体中文Windows操作系统中，ANSI 编码代表GBK 编码；在繁体中文Windows操作系统中，ANSI编码代表Big5；在日文Windows操作系统中，ANSI 编码代表Shift_JIS 编码。
    </p>
    <p>
      
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1560386556FM"/><div class="nodecontent">ObReferenceObjectByHandle</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1813791595FM"/><div class="nodecontent">NT_SUCCESS</div> <a onclick="getVisibleParents('FMID_559180774FM')" href="#FMID_559180774FM"><img src="12.1.2.5.HookNotity.html_files/ilink.png" class="ilink" alt="Arrow Link"/></a></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1520276539FM"/><div class="nodecontent">IoThreadToProcess</div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1373676220FM"/><div class="nodecontent">[go]list:</div></div></div></div>
</body></html>