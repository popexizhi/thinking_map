<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><!--This file has been created with freemind2html.xsl--><head><title>5.Hook/Notity</title><link rel="stylesheet" href="12.1.2.5.HookNotity.html_files/freemind2html.css" type="text/css"/><meta name="generator" content="FreeMind-XSL Stylesheet (see: http://freemind-xsl.dev.slash-me.net/ for details)"/><script type="text/javascript" src="12.1.2.5.HookNotity.html_files/freemind2html.js">  
	</script><script type="text/javascript"><!--
          
               function toggle(id)
               {
                   div_el = document.getElementById(id);
                   img_el = document.getElementById('img'+id);
                   if (div_el.style.display != 'none')
                   {
          
					
                      div_el.style.display='none';
                      img_el.src = '12.1.2.5.HookNotity.html_files/show.png';
          
                   }
                   else
                   {
          
                      div_el.style.display='block';
                      img_el.src = '12.1.2.5.HookNotity.html_files/hide.png';
          
                   };
               };
          
          --></script></head><body><h1>5.Hook/Notity</h1><div style="width:96%;  padding:2%;  margin-bottom:10px;  border: 0px;  text-align:center;  vertical-align:center;"><img src="12.1.2.5.HookNotity.html_files/image.png" style="margin-bottom:10px; &#9;border: 0px; &#9;text-align:center; &#9;vertical-align:center;" alt="Imagemap" usemap="#fm_imagemap"/></div><map name="fm_imagemap" id="fm_imagemap"><area shape="rect" href="#FMID_319096161FM" alt="5.Hook/Notity" title="5.Hook/Notity" coords="0,462,92,506" /><area shape="rect" href="#FMID_4798949FM" alt="code： KernelResumeInject" title="code： KernelResumeInject" coords="112,0,279,22" /><area shape="rect" href="#FMID_1260218891FM" alt="?list：" title="?list：" coords="112,390,159,412" /><area shape="rect" href="#FMID_559180774FM" alt="NTSTATUS" title="NTSTATUS" coords="179,55,273,77" /><area shape="rect" href="#FMID_51077595FM" alt="https://baike.baidu.com/item/NTSTATUS" title="https://baike.baidu.com/item/NTSTATUS" coords="293,25,524,47" /><area shape="rect" href="#FMID_761370124FM" alt="NTSTATUS 是被定义为32位的无符号长整型。在驱动程序开发中，人们习惯用  ..." title="NTSTATUS 是被定义为32位的无符号长整型。在驱动程序开发中，人们习惯用  ..." coords="293,50,905,108" /><area shape="rect" href="#FMID_1811169306FM" alt="NTAPI" title="NTAPI" coords="179,111,225,133" /><area shape="rect" href="#FMID_351632031FM" alt="PsGetCurrentProcess" title="PsGetCurrentProcess" coords="179,136,312,158" /><area shape="rect" href="#FMID_1668133398FM" alt="PsGetProcessImageFileName" title="PsGetProcessImageFileName" coords="179,161,360,183" /><area shape="rect" href="#FMID_1560386556FM" alt="ObReferenceObjectByHandle" title="ObReferenceObjectByHandle" coords="179,186,352,208" /><area shape="rect" href="#FMID_1813791595FM" alt="NT_SUCCESS" title="NT_SUCCESS" coords="179,211,293,233" /><area shape="rect" href="#FMID_591717623FM" alt="code编译有问题，处理依赖文件" title="code编译有问题，处理依赖文件" coords="179,238,382,260" /><area shape="rect" href="#FMID_1759781800FM" alt="[mark] build err" title="[mark] build err" coords="402,236,496,258" /><area shape="rect" href="#FMID_1520276539FM" alt="IoThreadToProcess" title="IoThreadToProcess" coords="179,263,320,285" /><area shape="rect" href="#FMID_1310656793FM" alt="KeAttachProcess" title="KeAttachProcess" coords="179,288,305,310" /><area shape="rect" href="#FMID_62920538FM" alt="PsGetCurrentProcess 与 NtCurrentProcess 的 ..." title="PsGetCurrentProcess 与 NtCurrentProcess 的 ..." coords="179,313,488,335" /><area shape="rect" href="#FMID_1852320084FM" alt="[?] why eax 是线程的入口地址？" title="[?] why eax 是线程的入口地址？" coords="179,338,361,360" /><area shape="rect" href="#FMID_73829894FM" alt="book code :   

 InjectShellCodeToProces ..." title="book code :   

 InjectShellCodeToProces ..." coords="179,363,811,531" /><area shape="rect" href="#FMID_912921034FM" alt="PsSetContextThread 

 [popexizhi: 

 这里的 ..." title="PsSetContextThread 

 [popexizhi: 

 这里的 ..." coords="179,534,737,647" /><area shape="rect" href="#FMID_516081623FM" alt="ZwFreeVirtualMemory 

 [popexizhi: 

 和Z ..." title="ZwFreeVirtualMemory 

 [popexizhi: 

 和Z ..." coords="179,650,779,726" /><area shape="rect" href="#FMID_586615918FM" alt="KeDetachProcess" title="KeDetachProcess" coords="179,729,311,751" /><area shape="rect" href="#FMID_687058286FM" alt="ObDereferenceObject" title="ObDereferenceObject" coords="179,754,330,776" /><area shape="rect" href="#FMID_1373676220FM" alt="[go]list:" title="[go]list:" coords="112,837,163,859" /><area shape="rect" href="#FMID_1315031202FM" alt="[thinking] note how  to be better for li ..." title="[thinking] note how  to be better for li ..." coords="183,835,400,857" /><area shape="rect" href="#FMID_986926267FM" alt="[popexizhi： 

 感觉这个就ok，可以类比:http://xuyaf ..." title="[popexizhi： 

 感觉这个就ok，可以类比:http://xuyaf ..." coords="420,779,844,909" /><area shape="rect" href="#FMID_496852701FM" alt="[next]blog目录如何构建" title="[next]blog目录如何构建" coords="864,820,1000,842" /><area shape="rect" href="#FMID_1786638920FM" alt="[next] code分割的css如何" title="[next] code分割的css如何" coords="864,845,1014,867" /><area shape="rect" href="#FMID_1139484812FM" alt="ps: sys 编译问题" title="ps: sys 编译问题" coords="112,912,214,934" /><area shape="rect" href="#FMID_569456552FM" alt="[popexizhi analysis]" title="[popexizhi analysis]" coords="112,937,230,959" /></map>

<div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65543&quot;)" id="imgN65543"/><a id="FMID_319096161FM"/><div class="nodecontent">5.Hook/Notity</div><div class="content" id="N65543"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_4798949FM"/><div class="nodecontent">code： KernelResumeInject</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65556&quot;)" id="imgN65556"/><a id="FMID_1260218891FM"/><div class="nodecontent">?list：</div><div class="content" id="N65556"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65563&quot;)" id="imgN65563"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_559180774FM"/><div class="nodecontent">NTSTATUS</div><div class="content" id="N65563"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_51077595FM"/><div class="nodecontent">https://baike.baidu.com/item/NTSTATUS</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_761370124FM"/><div class="nodecontent">
    <p>
      NTSTATUS 是被定义为32位的无符号长整型。在驱动程序开发中，人们习惯用 NTSTATUS 返回状态。其中0~0X7FFFFFFF，被认为是正确的状态，而0X80000000~0XFFFFFFFF被认为是错误的状态。
    </p>
    <p>
      有一个非常有用的宏-----NT_SUCCESS，用来检测状态是否正确。
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65602&quot;)" id="imgN65602"/><a id="FMID_1811169306FM"/><div class="nodecontent">NTAPI</div><div class="content" id="N65602"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_225088233FM"/><div class="nodecontent">https://bbs.csdn.net/topics/260042764</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65615&quot;)" id="imgN65615"/><a id="FMID_1475566776FM"/><div class="nodecontent">__stdcall</div><div class="content" id="N65615"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_297294380FM"/><div class="nodecontent">https://baike.baidu.com/item/__stdcall</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1274942921FM"/><div class="nodecontent">
    <p>
      __stdcall是函数调用约定的一种，函数调用约定主要约束了两件事：
    </p>
    <p>
      1.参数传递顺序
    </p>
    <p>
      2.调用堆栈由谁（调用函数或被调用函数）清理
    </p>
    <p>
      常见的函数调用约定：stdcall cdecl fastcall thiscall naked call
    </p>
    <p>
      __stdcall表示
    </p>
    <p>
      1.参数从右向左压入堆栈
    </p>
    <p>
      2.函数被调用者修改堆栈
    </p>
    <p>
      3.函数名(在编译器这个层次)自动加前导的下划线，后面紧跟一个@符号，其后紧跟着参数的尺寸
    </p>
    <p>
      在win32应用程序里,宏APIENTRY，WINAPI，都表示_stdcall，非常常见
    </p>
    <p>
      (PS：关键字主要见于Microsoft Visual C、C++。GNU的C、C++是另外一种修饰方式：__attribute__((stdcall)))
    </p>
  </div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65676&quot;)" id="imgN65676"/><a id="FMID_351632031FM"/><div class="nodecontent">PsGetCurrentProcess</div><div class="content" id="N65676"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1582134524FM"/><div class="nodecontent">
    <p>
      https://docs.microsoft.com/zh-cn/windows-hardware/drivers/kernel/mm-bad-pointer#psgetcurrentprocess
    </p>
    <p>
      Defined in: Ntddk.h
    </p>
    <p>
      Returns a pointer to the process of the current thread.
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65710&quot;)" id="imgN65710"/><a id="FMID_1668133398FM"/><div class="nodecontent">PsGetProcessImageFileName</div><div class="content" id="N65710"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1666501055FM"/><div class="nodecontent">
    <p>
      https://community.osr.com/discussion/109252/psgetprocessimagefilename
    </p>
    <p>
      
    </p>
    <p>
      问:in my filter driver, i would like to get the process name using PsGetProcessImageFileName. but it is not documented. can anyone tell me the pros and cons of using PsGetProcessImageFileName
    </p>
    <p>
      答:
    </p>
    <p>
      IIRC this only returns the short name (without directory path), it is ANSI
    </p>
    <p>
      and is limited to 8.3. These are the names you see in Task Manager.
    </p>
    <p>
      PsGetProcessImageFileName just returns the EPROCESS field, which has all of
    </p>
    <p>
      the above limitations.
    </p>
    <p>
      
    </p>
    <p>
      PS:
    </p>
    <p>
      1. PsGetProcessImageFileName 没有官方的文档说明
    </p>
    <p>
      2. PsGetProcessImageFileName 编码是ANSI,Task Manager中看到的名字返回，无路径说明。
    </p>
    <p>
      
    </p>
    <p>
      -ansi编码
    </p>
    <p>
      在简体中文Windows操作系统中，ANSI 编码代表GBK 编码；在繁体中文Windows操作系统中，ANSI编码代表Big5；在日文Windows操作系统中，ANSI 编码代表Shift_JIS 编码。
    </p>
    <p>
      
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65783&quot;)" id="imgN65783"/><a id="FMID_1560386556FM"/><div class="nodecontent">ObReferenceObjectByHandle</div><div class="content" id="N65783"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_275212106FM"/><div class="nodecontent">
    <p>
      code:
    </p>
    <p>
      status = ObReferenceObjectByHandle(\
    </p>
    <p>
                                               ThreadHandle,\  //这个是当前方法的input
    </p>
    <p>
                                               THREAD_ALL_ACCESS,\
    </p>
    <p>
                                               PsThreadType,\
    </p>
    <p>
                                               KernelMode,\
    </p>
    <p>
                                              &amp;pTargetThread,\
    </p>
    <p>
                                              NULL);
    </p>
    <p>
      [popexizhi:
    </p>
    <p>
      参数中要go的
    </p>
    <ul>
      <li>
        PsThreadType
      </li>
      <li>
        KernelMode
      </li>
    </ul>
    <p>
      这里的 PsThreadType定义为
    </p>
    <p>
      extern POBJECT_TYPE NTSYSAPI PsThreadType;
    </p>
    <p>
      ]
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65855&quot;)" id="imgN65855"/><a id="FMID_1791246322FM"/><div class="nodecontent">
    <p>
      https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/nf-wdm-obreferenceobjectbyhandle
    </p>
    <p>
      
    </p>
    <p>
      <font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="3">The </font><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="16px"><strong class="x-hidden-focus" style="font-weight: 600; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"><b>ObReferenceObjectByHandle</b></strong></font><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="3"> routine provides access validation on the object handle, and, if access can be granted, returns the corresponding pointer to the object's body.</font>
    </p>
    <p>
      [popexizhi译: obReferenceObjectByHandle  常规的对象句柄的访问权限验证， 如果验证通过，返回对象体指针位置]
    </p>
    <p>
      
    </p>
    <p>
      <font color="rgb(0, 0, 0)" face="Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, sans-serif" size="3">NTSTATUS </font><font color="rgb(0, 125, 154)" face="Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, sans-serif" size="3">ObReferenceObjectByHandle</font><font color="rgb(0, 0, 0)" face="Consolas, Menlo, Monaco, Lucida Console, Liberation Mono, DejaVu Sans Mono, Bitstream Vera Sans Mono, Courier New, monospace, sans-serif" size="3">( HANDLE Handle, ACCESS_MASK DesiredAccess, POBJECT_TYPE ObjectType, KPROCESSOR_MODE AccessMode, PVOID *Object, POBJECT_HANDLE_INFORMATION HandleInformation );</font>
    </p>
    <p>
      
    </p>
  </div><div class="content" id="N65855"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_351321578FM"/><div class="nodecontent">
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <code class="x-hidden-focus" style="line-height: 19px; font-family: monospace, monospace; font-size: 0.8rem; display: inline-block; padding-top: 3px; padding-bottom: 3px; padding-right: 7px; padding-left: 7px"><font face="monospace, monospace" size="3">[ObjectType] </font></code>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Pointer to the object type. <em>ObjectType</em> can be <strong style="font-weight: 600"><b>*ExEventObjectType</b></strong>, <strong style="font-weight: 600"><b>*ExSemaphoreObjectType</b></strong>, <strong style="font-weight: 600"><b>*IoFileObjectType</b></strong>, <strong style="font-weight: 600"><b>*PsProcessType</b></strong>, <strong style="font-weight: 600"><b>*PsThreadType</b></strong>, <strong style="font-weight: 600"><b>*SeTokenObjectType</b></strong>, <strong style="font-weight: 600"><b>*TmEnlistmentObjectType</b></strong>, <strong style="font-weight: 600"><b>*TmResourceManagerObjectType</b></strong>, <strong style="font-weight: 600"><b>*TmTransactionManagerObjectType</b></strong>, or <strong style="font-weight: 600"><b>*TmTransactionObjectType</b></strong>. </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">If <em>ObjectType</em> is not <strong style="font-weight: 600"><b>NULL</b></strong>, the operating system verifies that the supplied object type matches the object type of the object that <em>Handle</em> specifies. </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">[pope译: </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">如果ObjectType 不是NULL, 操作系统校验 提供的一个参数定义的</font><em class="x-hidden-focus" style="color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="16px">Handle</font></em><font size="3">是否匹配为此对象的类型。 </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3"> ] </font>
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1539531085FM"/><div class="nodecontent">
    <p class="" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <code class="x-hidden-focus" style="line-height: 19px; font-family: monospace, monospace; font-size: 0.8rem; display: inline-block; padding-top: 3px; padding-bottom: 3px; padding-right: 7px; padding-left: 7px"><font face="monospace, monospace" size="3">[AccessMode]</font></code>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Specifies the access mode to use for the access check. It must be either <strong style="font-weight: 600"><b>UserMode</b></strong> or <strong style="font-weight: 600"><b>KernelMode</b></strong>. Drivers should always specify <strong style="font-weight: 600"><b>UserMode</b></strong> for handles they receive from user address space. </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">[pope译: </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">指定访问模式 ，此模式是用来进行访问检测的；它只能是UserMode 或者 KernelMode。 </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">驱动 应该使用UserMode 的handles,用来接受用户地址空间内容。  </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">] </font>
    </p>
  </div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1813791595FM"/><div class="nodecontent">NT_SUCCESS</div> <a onclick="getVisibleParents('FMID_559180774FM')" href="#FMID_559180774FM"><img src="12.1.2.5.HookNotity.html_files/ilink.png" class="ilink" alt="Arrow Link"/></a></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66190&quot;)" id="imgN66190"/><img src="12.1.2.5.HookNotity.html_files/icons/stop.png" alt="stop"/> <a id="FMID_591717623FM"/><div class="nodecontent">code编译有问题，处理依赖文件</div> <a onclick="getVisibleParents('FMID_1139484812FM')" href="#FMID_1139484812FM"><img src="12.1.2.5.HookNotity.html_files/ilink.png" class="ilink" alt="Arrow Link"/></a><div class="content" id="N66190"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1759781800FM"/><div class="nodecontent">[mark] build err</div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66214&quot;)" id="imgN66214"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1520276539FM"/><div class="nodecontent">IoThreadToProcess</div> <a onclick="getVisibleParents('FMID_1520276539FM')" href="#FMID_1520276539FM"><img src="12.1.2.5.HookNotity.html_files/ilink.png" class="ilink" alt="Arrow Link"/></a><div class="content" id="N66214"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_235942452FM"/><div class="nodecontent">
    <p>
      https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-iothreadtoprocess
    </p>
    <p>
      <font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="16px">The <b style="font-weight: 600; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">IoThreadToProcess</b> routine returns a pointer to the process for the specified thread.</font>
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66266&quot;)" id="imgN66266"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1310656793FM"/><div class="nodecontent">KeAttachProcess</div><div class="content" id="N66266"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66276&quot;)" id="imgN66276"/><a id="FMID_1287026655FM"/><div class="nodecontent">
    <p>
      <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-keattachprocess">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-keattachprocess</a>
    </p>
    <p>
      
    </p>
    <p>
      <font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif">The </font><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="16px"><b style="font-weight: 600; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">KeAttachProcess</b></font><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif"> routine is exported to support existing driver binaries and is obsolete. </font>
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      [popexizhi: KeAttachProcess  当前不再推荐使用了， 替代使用是 KeStackAttachProcess
    </p>
    <p>
      <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kestackattachprocess">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kestackattachprocess </a>
    </p>
    <p>
      这个KeAttachProcess 说是导出出口，用以支持当前驱动使用，不是很明白为什么存在还要导出，想来是和机制有关go一下吧
    </p>
    <p>
      ]
    </p>
    <p>
      此方法的目的:
    </p>
    <p>
      <a href="http://www.ccidnet.com/2010/0714/2114941.shtml">http://www.ccidnet.com/2010/0714/2114941.shtml </a>
    </p>
    <p>
      <a href="http://www.ccidnet.com/2010/0714/2114941.shtml">
</a>    </p>
    <p>
      
    </p>
  </div><div class="content" id="N66276"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1535323722FM"/><div class="nodecontent">
    <p>
      KeAttachProcess() 函数的流程，
    </p>
    <p>
           当调用此函数时，
    </p>
    <p>
            首先从 KPCR 结构中得到当前线程 ETHREAD 结构，
    </p>
    <p>
            并提升当前 IRQL 为 DISPATCH_LEVEL（防止在进程切换中被其他软件列程所中断），
    </p>
    <p>
            并从形参中取出要切换进程的 EPROCESS结构与当前进程 EPROCESS 结构进行比较，
    </p>
    <p>
                    如果是当前进程的话，则降低当前 IRQL 为初始值，函数返回。
    </p>
    <p>
                    如果要进行切换的进程不是当前进程的话，
    </p>
    <p>
                          - 先要判断当前线程是否处于 APC 与 DPC 活动状态（ETHREAD-&gt;ApcStateIndex，KPCR-&gt;DpcRoutineActive），
    </p>
    <p>
                             -- 如果是则不允许动态切换进程，跳转到蓝屏处，系统崩溃。（微软规定在进行动态切换时不允许 APC ，DPC 列程运行，否则将系统崩溃，这应该不是必须的）
    </p>
    <p>
                             -- 如果不是则从形参中取当前线程（ETHREAD）、要切换的进程（EPROCESS）初始的 IRQL 值和当前线程的APC 保存状态 （ETHREAD-&gt;SavedApcState） 做为参数，来调用 KiAttachProcess()函 数完成具体的切换。
    </p>
    <p>
                            
    </p>
    <p>
                            
    </p>
    <p>
            从上面可以看出 KeAttachProcess() 函数只是进行了一些相关参数的设置和系统境的判断
    </p>
    <p>
              
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66423&quot;)" id="imgN66423"/><a id="FMID_1502018599FM"/><div class="nodecontent">ps</div><div class="content" id="N66423"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66429&quot;)" id="imgN66429"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1028105953FM"/><div class="nodecontent">1.KPCR</div><div class="content" id="N66429"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1907391463FM"/><div class="nodecontent">
    <p>
      <a href="https://blog.csdn.net/hu3167343/article/details/7612595">https://blog.csdn.net/hu3167343/article/details/7612595</a>
    </p>
    <p>
      
    </p>
    <p>
      由于Windows需要支持多个CPU,
    </p>
    <p>
                因此Windows内核中为此定义了一套以处理器控制区(Processor Control Region)即KPCR为枢纽的数据结构,
    </p>
    <p>
                    使每个CPU都有个KPCR.
    </p>
    <p>
                                  其中KPCR这个结构中有一个域KPRCB(Kernel Processor Control Block)结构, 这个结构扩展了KPCR. 这两个结构用来保存与线程切换相关的全局信息. 
    </p>
    <p>
      
    </p>
    <p>
               通常fs段寄存器在内核模式下指向KPCR,
    </p>
    <p>
               用户模式下指向TEB.
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1700658408FM"/><div class="nodecontent">
    <p>
      <a href="https://yangruiqiyr.com/2018/07/05/KPCR/#KPCR%EF%BC%9ACPU%E6%8E%A7%E5%88%B6%E5%8C%BA%EF%BC%88Processor-Control-Region%EF%BC%89">https://yangruiqiyr.com/2018/07/05/KPCR/#KPCR%EF%BC%9ACPU%E6%8E%A7%E5%88%B6%E5%8C%BA%EF%BC%88Processor-Control-Region%EF%BC%89</a>
    </p>
    <p>
      
    </p>
    <p>
      KPCR相当于一个副本，存储着线程相关的一些重要信息，这样CPU在处理时就不用查线程了。
    </p>
    <p>
      1) 当线程进入0环时，FS:[0]指向KPCR(3环时FS:[0] -&gt; TEB)
    </p>
    <p>
      2) 每个CPU都有一个KPCR结构体(一个核一个)
    </p>
    <p>
      3) KPCR中存储了CPU本身要用的一些重要数据：GDT、IDT以及线程相关的一些信息。
    </p>
    <p>
      (在winbbg中查看KPCR结构体)
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1343431754FM"/><div class="nodecontent">
    <p>
      [popexizhi:
    </p>
    <p>
      KPCR 是每个cpu对 对线程的信息副本，
    </p>
    <p>
                    线程进入0环（内核模式下）时fs段寄存器指向地址  ]
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66555&quot;)" id="imgN66555"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_574174565FM"/><div class="nodecontent">2.ETHREAD 结构</div><div class="content" id="N66555"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_591951090FM"/><div class="nodecontent">https://blog.csdn.net/Sunny_wwc/article/details/6566438</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1152471627FM"/><div class="nodecontent">
    <p>
      <font color="rgb(79, 79, 79)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="3">Windows会 </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="3">  - 给每一个进程建立一个EPROCESS结构， </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="3">    - EPROCESS结构第一个成员是KPROCESS结构， </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="3">  - 给每一个线程建立ETHREAD结构， </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="3">    - ETHREAD结构第一个成员是KTHREAD结构。</font>
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66633&quot;)" id="imgN66633"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1582702391FM"/><div class="nodecontent">3. IRQL 是？ 如何提升</div><div class="content" id="N66633"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_715392681FM"/><div class="nodecontent">https://blog.csdn.net/u014805066/article/details/77450855</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1840499249FM"/><div class="nodecontent">
    <p>
      <font color="rgb(51, 51, 51)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="3"><b><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-weight: 700">DISPATCH_LEVEL：</strong></b></font><font color="rgb(51, 51, 51)" face="Arial" size="3"> 为了能够执行多任务，系统必须允许线程调度。而线程调度的根本就是靠时钟中断来保证的，该级别的中断即调度中断。当你的代码运行的IRQL被提升为DISPATH_LEVEL时，就意味着你的代码不在受线程中断影响力。你的代码会一直运行直到你将IRQL设置为低于DISPATH_LEVEL为止。 </font>
    </p>
    <p>
      <font color="rgb(51, 51, 51)" face="Arial" size="3">-- 这中间如果发生缺页错误之类的IRQL级别在DISPATH_LEVEL之下的严重中断时，这些中断均不会被处理。这时，代码将无法正常运行。所以，DISPATH_LEVEL的使用绝对要慎之又慎。只有在是偶那个自旋锁时，你才应该考虑选择该IRQL。 [popexizhi: 这个也是KeAttachProcess中分析， ”如果</font><b>当前线程是否处于 APC 与 DPC 活动状态，系统要蓝屏处理的原因“</b><font color="rgb(51, 51, 51)" face="Arial" size="3">]</font>
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66699&quot;)" id="imgN66699"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1598205685FM"/><div class="nodecontent">4.APC与DPC</div><div class="content" id="N66699"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66709&quot;)" id="imgN66709"/><a id="FMID_927661063FM"/><div class="nodecontent">https://blog.csdn.net/zhiquan/article/details/4240400</div><div class="content" id="N66709"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1490662199FM"/><div class="nodecontent">
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">当驱动程序处理IRP的时候，它可能立刻完成，也可能在中断里才能完成，比如说，往硬件设备发出一个请求（通常可以是写I/O port），当设备完成操作的时候会触发一个中断，然后在中断处理函数里得到操作结果。 </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">   Windows有两类中断，硬件设备的中断和软中断，分成若干个不 同的优先级（IRQL）。 </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">              -  软中断主要有两种： </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">                           -- DPC(Delayed Procedure Call)和 </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">                           -- APC(Asynchronous Procedure Call)， </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">              都处于较低的优先级。 </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">          驱动程序可以为硬件中断注册ISR(Interrupt Service Routine)，一般就是修改IDT某个条目的入口。 </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">同样，操作系统也会为DPC和APC注册适当的中断处理例程（也是在IDT中）。 </font>
    </p>
    <p>
      
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">值得指出的 是， </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">   -  DPC是跟处理器相关的，每个处理器会有一个DPC队列， </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">  - 而APC是跟线程相关的，每个线程会有它的</font><a name="baidusnap0" target="_blank" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; color: rgb(78, 161, 219); text-decoration: none; font-family: Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif; font-size: 14px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"><font color="rgb(78, 161, 219)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="14px">
</font></a><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-weight: 700; font-family: -apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun; font-size: 14px; font-style: normal; letter-spacing: normal; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0)"><b><font face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4" color="rgb(0, 0, 0)">APC队列</font></b></strong><font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">（实际上包括一个Kernel </font><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-weight: 700; font-family: -apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun; font-size: 14px; font-style: normal; letter-spacing: normal; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0)"><b><font face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4" color="rgb(0, 0, 0)">APC队列</font></b></strong><font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">和User </font><strong style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-weight: 700; font-family: -apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun; font-size: 14px; font-style: normal; letter-spacing: normal; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0)"><b><font face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4" color="rgb(0, 0, 0)">APC队列</font></b></strong><font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">，它们的调度策略有所区别）， </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">                可以想象，APC并不算严格意义上的中断，因为中断可能发生在任何一个线程的上下文中，它被称为中断，主要是因为 IRQL的提升（从PASSIVE到APC），APC的调度一般在线程切换等等情形下进行。 </font>
    </p>
    <p>
      
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">当中断发生的时候，操作系统会调用中断处理例程，对于硬件设备 的ISR，一般处理是关设备中断，发出一个DPC请求，然后返回。不在设备的中断处理中使用太多的CPU时间，主要考虑是否则可能丢失别的中断。 </font>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="-apple-system, SF UI Text, Arial, PingFang SC, Hiragino Sans GB, Microsoft YaHei, WenQuanYi Micro Hei, sans-serif, SimHei, SimSun" size="4">由于硬件 设备中断的IRQL比DPC中断的高，所以在ISR里面DPC会阻塞，直到ISR返回IRQL回到较低的水平，才会触发DPC中断，在DPC中断里执行从 硬件设备读取数据以及重新请求、开中断等操作。ISR或者DPC可能在任何被中断的线程上下文（arbitrary thread context）执行，事实上线程的上下文是不可见的，可以认为是系统借用一下时间片而已。</font>
    </p>
  </div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66914&quot;)" id="imgN66914"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_1912202156FM"/><div class="nodecontent">6.KiAttachProcess</div><div class="content" id="N66914"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_977914958FM"/><div class="nodecontent">http://codewarrior.cn/ntdoc/winnt/ke/KiAttachProcess.htm</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1591011162FM"/><div class="nodecontent">
    <pre style="padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; line-height: 15.6px; color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; word-spacing: 0px"><code><b><font size="2">Routine Description:</font></b><font size="2">    This function attaches a thread to a target process' address space.

    N.B. The dispatcher database lock must be held when this routine is
        called.</font></code></pre>
  </div></div></div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_490062064FM"/><div class="nodecontent"/></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66967&quot;)" id="imgN66967"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_62920538FM"/><div class="nodecontent">PsGetCurrentProcess 与 NtCurrentProcess 的区别</div><div class="content" id="N66967"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1397569388FM"/><div class="nodecontent">
    <p>
      PsGetCurrentProcess
    </p>
    <p>
      <a href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/kernel/mm-bad-pointer#psgetcurrentprocess">https://docs.microsoft.com/zh-cn/windows-hardware/drivers/kernel/mm-bad-pointer#psgetcurrentprocess</a>
    </p>
    <p>
      
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Defined in: Ntddk.h </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Returns a pointer to the process of the current thread. </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <strong style="font-weight: 600"><b><font size="3">Return value</font></b></strong>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">A pointer to an opaque process object. </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Available starting with Windows 2000. </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">IRQL: Any level</font>
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67059&quot;)" id="imgN67059"/><a id="FMID_1986903444FM"/><div class="nodecontent">
    <p>
      NtCurrentProcess
    </p>
    <p>
      <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/mm-bad-pointer">https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/mm-bad-pointe</a>
    </p>
    <h2 id="zwcurrentprocess" class="heading-with-anchor" style="font-weight: 600; line-height: 1.3; margin-bottom: 12px; margin-top: 32px; font-size: 1.75rem; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-style: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <strong style="font-weight: 600"><b>ZwCurrentProcess</b></strong><a class="docon docon-link heading-anchor" tabindex="-1" aria-hidden="true" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/mm-bad-pointer#zwcurrentprocess" style="color: black; text-decoration: none; font-family: docons; font-size: 0.8em; display: inline-block; font-style: normal; font-weight: 400; font-variant: normal; text-transform: none; text-align: center; line-height: 16px; margin-top: 0px; margin-right: 0px; margin-bottom: 4px; margin-left: 10px; vertical-align: middle"><font color="black" face="docons" size="0.8em">
</font></a>    </h2>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Defined in: Wdm.h </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">The <strong style="font-weight: 600"><b>ZwCurrentProcess</b></strong> macro returns a handle to the current process. </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <strong style="font-weight: 600"><b><font size="3">Return value</font></b></strong>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <strong style="font-weight: 600"><b><font size="3">HANDLE</font></b></strong>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <strong style="font-weight: 600"><b><font size="3">ZwCurrentProcess</font></b></strong><font size="3"> returns a special handle value that represents the current process. </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">The returned value is not a true handle, but it is a special value that always represents the current process. </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <strong style="font-weight: 600"><b><font size="3">NtCurrentProcess</font></b></strong><font size="3"> and <strong style="font-weight: 600"><b>ZwCurrentProcess</b></strong> are two versions of the same Windows Native System Services routine. The <strong style="font-weight: 600"><b>NtCurrentProcess</b></strong> routine in the Windows kernel is not directly accessible to kernel-mode drivers. However, kernel-mode drivers can access this routine indirectly by calling <strong style="font-weight: 600"><b>ZwCurrentProcess</b></strong>. </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">For calls from kernel-mode drivers, the <strong style="font-weight: 600"><b>Nt_Xxx_</b></strong> and <strong style="font-weight: 600"><b>Zw_Xxx_</b></strong> versions of a Windows Native System Services routine can behave differently in the way that they handle and interpret input parameters. For more information about the relationship between the <strong style="font-weight: 600"><b>Nt_Xxx_</b></strong> and <strong style="font-weight: 600"><b>Zw_Xxx_</b></strong> versions of a routine, see </font><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/using-nt-and-zw-versions-of-the-native-system-services-routines" data-linktype="relative-path" class="x-hidden-focus" style="color: black; text-decoration: underline"><font color="black" size="3"><u>Using Nt and Zw Versions of the Native System Services Routines</u></font></a><font size="3">. </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">All supported operating systems. </font>
    </p>
    <p style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">IRQL: Any level </font>
    </p>
  </div><div class="content" id="N67059"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_861862497FM"/><div class="nodecontent"/></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1477822466FM"/><div class="nodecontent">
    <p>
      [popexizhi:
    </p>
    <p>
      PsGetCurrentProcess 返回的是 value ，只不过是 当前线程所在进程的pid值；
    </p>
    <p>
      而NtCurrentProcess返回的是handle ,当前进程的handle
    </p>
    <p>
      这里NtCurrentProcess 还有一个对应的ZwCurrentProcess，这里的区别
    </p>
    <p>
      <a href="https://blog.csdn.net/int2e/article/details/1998833">参见: https://blog.csdn.net/int2e/article/details/1998833 </a>
    </p>
    <p>
      <font color="rgb(51, 51, 51)" face="Courier New">  </font><font color="rgb(51, 51, 51)" face="Courier New" size="3">ntdll.dll中ZwCreateFile与ntoskrnl.exe中ZwCreateFile的区别是：前者是user Mode application called，后者是Kernel Mode driver Called;<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>   ntdll.dll中NtCreateFile与ntoskrnl.exe中NtCreateFile区别是：前者在ring3下工作，后者在ring0下工作；前者通过中断实现，后者是前者的中断处理程序</font>
    </p>
    <p>
      ]
    </p>
    <p>
      PS: os中ring3与ring0的区别
    </p>
    <p>
      <a href="https://www.cnblogs.com/pcajax/archive/2011/03/16/1986407.html">https://www.cnblogs.com/pcajax/archive/2011/03/16/1986407.html</a>
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="Verdana, Geneva, Arial, Helvetica, sans-serif" size="13px">现在的OS，包括Windows和Linux都没有采用4层权限，而只是使用2层——R0层和R3层，分别来存放操作系统数据和应用程序数据，从而导致一旦驱动加载了，就运行在R0层，就拥有了和操作系统同样的权限，可以做任何事情，而所谓的rootkit也就随之而生了</font>
    </p>
    <p>
      
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67349&quot;)" id="imgN67349"/><a id="FMID_1852320084FM"/><div class="nodecontent">[?] why eax 是线程的入口地址？</div><div class="content" id="N67349"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_437348524FM"/><div class="nodecontent">
    <p>
      猜测: 与keAttachProcess有关
    </p>
    <p>
      no
    </p>
    <p>
      根据keAttachProcess的调用过程分析，此方法使用前pTargetProc 的eax的值应该是第一线程入口了
    </p>
  </div> <a onclick="getVisibleParents('FMID_1310656793FM')" href="#FMID_1310656793FM"><img src="12.1.2.5.HookNotity.html_files/ilink.png" class="ilink" alt="Arrow Link"/></a></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67390&quot;)" id="imgN67390"/><a id="FMID_1177569646FM"/><div class="nodecontent">
    <p>
      猜测 DetourNtResumeThread 调用时刻，eax的是线程入口地址吗?
    </p>
  </div><div class="content" id="N67390"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67409&quot;)" id="imgN67409"/><a id="FMID_732006991FM"/><div class="nodecontent">analysis</div><div class="content" id="N67409"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67415&quot;)" id="imgN67415"/><a id="FMID_1120205916FM"/><div class="nodecontent">
    <p>
      [next]
    </p>
    <p>
      当前pTargetProc是入参threadHandle的地址
    </p>
    <p>
      ，而此入参threadHandle的调用来自于
    </p>
    <p>
      OriginalNtResumeThread=(PFN_NtResumeThread)HookSSDTServiceByIndex(g_IndexNtResumeThread,(ULONG_PTR)DetourNtResumeThread);
    </p>
    <p>
      [next] 这个g_IndexNtResumeThread的赋值位置查找，和HookSSDTServiceByIndex的使用说明查找
    </p>
    <ul>
      <li>
        g_IndexNtResumeThread
      </li>
      <li>
        HookSSDTServiceByIndex
      </li>
    </ul>
    <p>
      [问题记录]
    </p>
    <p>
      根据g_IndexNtResumeThread 中查询到的对于NtResumeThread的hook来完成的，
    </p>
    <p>
      这里推测当前eax的作为线程入口的状态是这里保证的，但是为什么是eax呢，这个还没有查询到具体的原因
    </p>
    <p>
      记录问题，[next ] 考虑应该看一下NtResumeThread调用后，对目的进程的修改和完成情况来评估这个eax的原因 。
    </p>
  </div><div class="content" id="N67415"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67467&quot;)" id="imgN67467"/><a id="FMID_844382180FM"/><div class="nodecontent">
    <ul>
      <li>
        g_IndexNtResumeThread
      </li>
    </ul>
  </div><div class="content" id="N67467"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_196632213FM"/><div class="nodecontent">
    <p>
      [next]
    </p>
    <p>
      定义在BOOL InitServiceIndex()中如下:
    </p>
    <p>
      
    </p>
    <p>
      g_IndexNtResumeThread = GetServiceIndexByName(MapedNtdllBase,"NtResumeThread");
    </p>
    <p>
      
    </p>
    <p>
      这里的"NtResumeThread" 介绍为
    </p>
    <p>
      <font face="Simsun" color="rgb(51, 51, 51)" size="3">大概流程如下:<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/><br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>Kernel32!CreateProcessW<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>Kernel32!CreateProcessInternalW<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>ntdll!NtCreateProcessEx<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>ntdll!NtCreateThread<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>ntdll!NtResumeThread<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/><br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>因为进程创建后，Windows 必须为它创建一个主线程，然后等待操作系统调度它。<br align="start" size="3" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/></font><font face="Simsun" color="#006633" size="3"><b><u>所以调用NtResumeThread的时候，就是我们Hook的最佳时机，因为此时创建进程的主要工作已经完成，<br align="start" size="3" color="#006633" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; letter-spacing: normal; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)"/>但是进程并没有调度起来</u></b></font><font face="Simsun" color="rgb(51, 51, 51)" size="3">，呵呵，方便干坏事啊。 </font>
    </p>
    <p>
      [thinking 这里应该是eax的位置为第一个线程入口的原因吧？但是NtResumeThread 的具体内容go一下，确定一下]
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      参考: <a href="https://blog.csdn.net/zhou191954/article/details/10164459">https://blog.csdn.net/zhou191954/article/details/10164459</a>
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_506303043FM"/><div class="nodecontent">
    <ul>
      <li>
        HookSSDTServiceByIndex
      </li>
    </ul>
  </div></div></div></div></div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67637&quot;)" id="imgN67637"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_73829894FM"/><div class="nodecontent">
    <p>
      book code :  
    </p>
    <p>
      InjectShellCodeToProcess(pTargetProc, pContext, g_DllPathToInject)
    </p>
    <p>
      source code:
    </p>
    <p>
      status = InjectShellCodeToProcessByModifyContext(pContext,g_DllPathToInject);
    </p>
    <p>
      list ?：
    </p>
    <ul>
      <li>
        why change? pTargetProc 去哪里了？不需要了吗？ [这里的过程, InjectShellCodeToProcessByModifyContext 的input是改自身copy的pContext,不用pTargetProc 了.]
      </li>
      <li>
        what for the fun [修改copy 自目标targetThread 的 pContext]
      </li>
    </ul>
  </div><div class="content" id="N67637"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1976457873FM"/><div class="nodecontent">
    <p>
      NTSTATUS InjectShellCodeToProcessByModifyContext(PCONTEXT pContext,WCHAR *wstrDllPath)
    </p>
    <p>
      的定义中如下:
    </p>
    <p>
      uNtdllBase = FindImageBase(NtCurrentProcess(),L"ntdll.dll");   
    </p>
    <p>
      //[popexizhi: ?why? ntdll.dll 这个和下面的LdrLoadDll 都是要注册的目标线程中的吗?  ]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    </p>
    <p>
      if (uNtdllBase != 0)
    </p>
    <p>
      {
    </p>
    <p>
      //先申请内存
    </p>
    <p>
      status = ZwAllocateVirtualMemory(NtCurrentProcess(),
    </p>
    <p>
      &amp;pData,0,&amp;MemSize,MEM_COMMIT,PAGE_EXECUTE_READWRITE);
    </p>
    <p>
      
    </p>
    <p>
      if (NT_SUCCESS(status))
    </p>
    <p>
      {
    </p>
    <p>
      dprintf("Allocated Mem = 0x%p\n",pData);
    </p>
    <p>
      dprintf("ntdll.dll Base = 0x%p \n",uNtdllBase);
    </p>
    <p>
      AddrOfLdrLoadDll = KeGetProcAddress(uNtdllBase,"LdrLoadDll");
    </p>
    <p>
      dprintf("LdrLoadDll = 0x%p \n",AddrOfLdrLoadDll);
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67747&quot;)" id="imgN67747"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_912921034FM"/><div class="nodecontent">
    <p>
      PsSetContextThread
    </p>
    <p>
      [popexizhi:
    </p>
    <p>
      这里的目的是把InjectShellCodeToProcessByModifyContext 处理的pContext中的内容，改到对应的
    </p>
    <p>
      pTargetProc中去
    </p>
    <p>
      ]
    </p>
    <p>
      <code>This function sets the usermode context of the specified thread</code>
    </p>
  </div><div class="content" id="N67747"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1371145802FM"/><div class="nodecontent">
    <p>
      <a href="http://codewarrior.cn/ntdoc/wrk/ps/PsSetContextThread.htm">http://codewarrior.cn/ntdoc/wrk/ps/PsSetContextThread.htm </a>
    </p>
    <pre style="padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; line-height: 15.6px; color: rgb(0, 0, 0); font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; word-spacing: 0px"><code><b>Routine Description:</b>
    This function sets the usermode context of the specified thread. This
    function will fail if the specified thread is a system thread. It will
    return the wrong answer if the thread is a non-system thread that does
    not execute in user-mode.

<b>Arguments:</b>
    Thread       - Supplies the thread object from
                   which to retrieve context information.

    ThreadContext - Supplies the address of a buffer that contains new
                    context for the specified thread.

    Mode          - Mode to use for validation checks.</code></pre>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_516081623FM"/><div class="nodecontent">
    <p>
      ZwFreeVirtualMemory
    </p>
    <p>
      [popexizhi:
    </p>
    <p>
      和ZwAllocateVirtualMemory 对应吧，用完了就释放，pContext已经拷贝到pTargetThread了，这里处理内存
    </p>
    <p>
      ]
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67855&quot;)" id="imgN67855"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_586615918FM"/><div class="nodecontent">KeDetachProcess</div><div class="content" id="N67855"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_528210800FM"/><div class="nodecontent">
    <p>
      <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kedetachprocess">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/ntifs/nf-ntifs-kedetachprocess</a>
    </p>
    <p>
      
    </p>
    <p>
      <font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="3">The </font><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="16px"><b class="x-hidden-focus" style="font-weight: 600; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">KeDetachProcess</b></font><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="3"> routine is exported to support existing driver binaries and is obsolete. Use </font><a href="https://msdn.microsoft.com/library/windows/hardware/ff549677" data-linktype="external" style="background-color: rgb(255, 255, 255); color: black; text-decoration: underline; font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px"><font color="black" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="3"><u>KeUnstackDetachProcess</u></font></a><font color="rgb(0, 0, 0)" face="Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif" size="3"> instead</font>
    </p>
    <p>
      
    </p>
    <p>
      [popexizhi:
    </p>
    <p>
      <a href="https://blog.csdn.net/dasgk/article/details/17741289">https://blog.csdn.net/dasgk/article/details/17741289</a>
    </p>
    <p>
      
    </p>
    <p>
      KeDetachProcess
    </p>
    <p>
      　　当线程从新的进程中脱离时(KeDetachProcess), 任何在新的进程地址空间中等待执行的未决的内核APCs被派发执行。随后SavedApcState 域的内容被拷贝回ApcState域。SavedApcState 域的内容被清空，线程的ApcStateIndex域被设为OriginalApcEnvironment，ApcStatePointer域更新，当前进程上下文切换到线程所属进程。
    </p>
    <p>
          Dettach时，先派发APC State里面的APC，然后再恢复，也就是挂靠过程中线程被插apc现在要集中解决
    </p>
    <p>
      
    </p>
    <p>
      [popexizhi: 总结一下，这里KeDetachProcess,是在 KeAttachProcess完成后，将线程从新的进程中脱离过程，这里要先处理APC队列，之后再恢复ApcState域]
    </p>
    <p>
      ]
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67963&quot;)" id="imgN67963"/><a id="FMID_371107448FM"/><div class="nodecontent">code 分析</div><div class="content" id="N67963"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N67969&quot;)" id="imgN67969"/><a id="FMID_1288113632FM"/><div class="nodecontent">
    <p>
      <font color="rgb(79, 79, 79)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif" size="16px">KeAttachProcess</font>
    </p>
    <p>
      KiAttachProcess - KeAttachProcess仅仅是对这个函数的封装
    </p>
    <p>
      KiSwapProcess - 更换地址空间。（本质上就是重新加载CR3）
    </p>
    <p>
      SwapContext - 更换上下文。一般不管地址空间的切换，只调整线程上下文。
    </p>
    <p>
      KiSwapThred - 切换到链表中的下一个线程（SwapContext）调用
    </p>
    <p>
      
    </p>
  </div><div class="content" id="N67969"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_841157296FM"/><div class="nodecontent">
    <p>
      -----------------------------------------------------------------------------
    </p>
    <p>
      /************************ KeAttachProcess ***************************/
    </p>
    <p>
      // just wrapper
    </p>
    <p>
      //
    </p>
    <p>
      KeAttachProcess(EPROCESS *Process)
    </p>
    <p>
      {
    </p>
    <p>
      KiAttachProcess(Process,KeRaiseIrqlToSynchLevel);
    </p>
    <p>
      }
    </p>
    <p>
      /************************ KiAttachProcess ***************************/
    </p>
    <p>
      
    </p>
    <p>
      KiAttachProcess(EPROCESS *Process,Irql){
    </p>
    <p>
      
    </p>
    <p>
      //CurThread=fs:124h
    </p>
    <p>
      //CurProcess=CurThread-&gt;ApcState.Process;
    </p>
    <p>
      
    </p>
    <p>
      if(CurProcess!=Process){
    </p>
    <p>
      //[popexizhi: 如果要attach 的process非当前进程，才如下操作:]
    </p>
    <p>
              if(CurProcess-&gt;ApcStateIndex || KPCR-&gt;DpcRoutineActive)KeBugCheckEx...
    </p>
    <p>
              //[popexizhi:如果当前进程有Apc状态的索引，这个应该是进入apc列表了 CurProcess-&gt;ApcStateIndex
    </p>
    <p>
              //或者: KPCR 中 有DPC队列，这个是cpu的队列，这里注意是判断是不是这两种软中断中，如果是后面就KeBugCheckEx.. ,传说的系统崩溃吗?
    </p>
    <p>
      //]
    </p>
    <p>
      }
    </p>
    <p>
      
    </p>
    <p>
      //if we already in process's context,
    </p>
    <p>
      //[popexizhi: 要attach 的process 就是当前进程，恢复lrql，返回就ok，不用特殊处理了]
    </p>
    <p>
      if(CurProcess==Process){KiUnlockDispatcherDatabase(Irql);return;}
    </p>
    <p>
      
    </p>
    <p>
      Process-&gt;StackCount++;//[?-ok 1- 这是堆栈计数增加一个吗? 不是，参见下文]
    </p>
    <p>
      // <font color="rgb(51, 51, 51)" face="Helvetica Neue, Helvetica, Tahoma, Arial, STXihei, Microsoft YaHei, ??????, sans-serif">注意代码中的Process-&gt;StackCount与进程的“堆栈”并无关系，而是指进程挂靠的嵌套深度。 </font>
    </p>
    <p>
      <font color="rgb(51, 51, 51)" face="Helvetica Neue, Helvetica, Tahoma, Arial, STXihei, Microsoft YaHei, ??????, sans-serif">// </font><a href="http://www.voidcn.com/article/p-umtyvddi-qc.html">http://www.voidcn.com/article/p-umtyvddi-qc.html</a>
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      KiMoveApcState(&amp;CurThread-&gt;ApcState,&amp;CurThread-&gt;SavedApcState);//[ 2-KiMoveApcState， 将当前线程的APC状态保持到SavedApcState中
    </p>
    <p>
      //    http://codewarrior.cn/ntdoc/win2k/ke/KiMoveApcState.htm
    </p>
    <p>
      //    This function moves the APC state from the source structure to the
    </p>
    <p>
      //    destination structure and reinitializes list headers as appropriate.
    </p>
    <p>
      
    </p>
    <p>
      // init lists
    </p>
    <p>
      CurThread-&gt;ApcState.ApcListHead[0].Blink=&amp;CurThread-&gt;ApcState.ApcListHead[0]; //[?]3 这里的ApcListHead[01].[Blink,Flink]分别是什么，这操作的目的是?
    </p>
    <p>
      /*  [popexizhi: 自己在另外的版本中查到的初始化如下: 这里的InitializeListHead与下面的区别是什么，只是这里做封装了吗?]
    </p>
    <p>
      InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[KernelMode]); //ApcState被初始化
    </p>
    <p>
      InitializeListHead(&amp;Thread-&gt;ApcState.ApcListHead[UserMode]);
    </p>
    <p>
      */
    </p>
    <p>
        CurThread-&gt;ApcState.ApcListHead[0].Blink=&amp;CurThread-&gt;ApcState.ApcListHead[0]; //[?]3 这里的ApcListHead[01].[Blink,Flink]分别是什么，这操作的目的是?
    </p>
    <p>
        CurThread-&gt;ApcState.ApcListHead[0].Flink=&amp;CurThread-&gt;ApcState.ApcListHead[0];
    </p>
    <p>
        CurThread-&gt;ApcState.ApcListHead[1].Blink=&amp;CurThread-&gt;ApcState.ApcListHead[1];
    </p>
    <p>
        CurThread-&gt;ApcState.ApcListHead[1].Flink=&amp;CurThread-&gt;ApcState.ApcListHead[1];;
    </p>
    <p>
      
    </p>
    <p>
       //fill curtheads's fields
    </p>
    <p>
       CurThread-&gt;ApcState.Process=Process;
    </p>
    <p>
      //
    </p>
    <p>
      CurThread-&gt;ApcState.ApcListHead[0].Flink=&amp;CurThread-&gt;ApcState.ApcListHead[0];
    </p>
    <p>
      CurThread-&gt;ApcState.ApcListHead[1].Blink=&amp;CurThread-&gt;ApcState.ApcListHead[1];
    </p>
    <p>
      CurThread-&gt;ApcState.ApcListHead[1].Flink=&amp;CurThread-&gt;ApcState.ApcListHead[1];;
    </p>
    <p>
      
    </p>
    <p>
      //fill curtheads's fields
    </p>
    <p>
      CurThread-&gt;ApcState.Process=Process;
    </p>
    <p>
      
    </p>
    <p>
      CurThread-&gt;ApcState.KernelApcInProgress=0;
    </p>
    <p>
      CurThread-&gt;ApcState.KernelApcPending=0;
    </p>
    <p>
      CurThread-&gt;ApcState.UserApcPending=0;
    </p>
    <p>
      
    </p>
    <p>
      CurThread-&gt;ApcState.ApcStatePointer.SavedApcState=&amp;CurThread-&gt;SavedApcState;
    </p>
    <p>
      CurThread-&gt;ApcState.ApcStatePointer.ApcState=&amp;CurThread-&gt;ApcState;
    </p>
    <p>
      
    </p>
    <p>
      CurThread-&gt;ApcStateIndex=1;
    </p>
    <p>
      
    </p>
    <p>
      //if process ready, just swap it...
    </p>
    <p>
      if(!Process-&gt;State)//state==0, ready
    </p>
    <p>
      {
    </p>
    <p>
      KiSwapProcess(Process,CurThread-&gt;SavedApcState.Process);
    </p>
    <p>
      KiUnlockDispatcherDatabase(Irql);
    </p>
    <p>
      return;
    </p>
    <p>
      }
    </p>
    <p>
      
    </p>
    <p>
      CurThread-&gt;State=1; //ready?
    </p>
    <p>
      CurThread-&gt;ProcessReadyQueue=1;
    </p>
    <p>
      
    </p>
    <p>
      //put Process in Thread's waitlist
    </p>
    <p>
      CurThread-&gt;WaitListEntry.Flink=&amp;Process-&gt;ReadyListHead.Flink;
    </p>
    <p>
      CurThread-&gt;WaitListEntry.Blink=Process-&gt;ReadyListHead.Blink;
    </p>
    <p>
      
    </p>
    <p>
      Process-&gt;ReadyListHead.Flink-&gt;Flink=&amp;CurThread-&gt;WaitListEntry.Flink;
    </p>
    <p>
      Process-&gt;ReadyListHead.Blink=&amp;CurThread-&gt;WaitListEntry.Flink;
    </p>
    <p>
      
    </p>
    <p>
      // else, move process to swap list and wait
    </p>
    <p>
      if(Process-&gt;State==1){//idle?
    </p>
    <p>
      Process-&gt;State=2; //trans
    </p>
    <p>
      Process-&gt;SwapListEntry.Flink=&amp;KiProcessInSwapListHead.Flink;
    </p>
    <p>
      Process-&gt;SwapListEntry.Blink=KiProcessInSwapListHead.Blink;
    </p>
    <p>
      KiProcessInSwapListHead.Blink=&amp;Process-&gt;SwapListEntry.Flink;
    </p>
    <p>
      KiSwapEvent.Header.SignalState=1;
    </p>
    <p>
      if(KiSwapEvent.Header.WaitListHead.Flink!=&amp;KiSwapEvent.Header.WaitListHead.
    </p>
    <p>
      Flink)
    </p>
    <p>
      KiWaitTest(&amp;KiSwapEvent,0xa); //fastcall
    </p>
    <p>
      }
    </p>
    <p>
      
    </p>
    <p>
      CurThread-&gt;WaitIrql=Irql;
    </p>
    <p>
      KiSwapThread();
    </p>
    <p>
      return;
    </p>
    <p>
      }
    </p>
    <p>
      
    </p>
    <p>
      从这个函数可以得到以下结论。进程可以处于以下状态——0（准备），1（Idle），2（Tra
    </p>
    <p>
      ns——切换）。这证实了高层次的信息。KiAttachProcess使用了另外两个函数KiSwapProce
    </p>
    <p>
      ss和KiSwapThread。
    </p>
    <p>
      
    </p>
    <p>
      /************************* KiSwapProcess ****************************/
    </p>
    <p>
      
    </p>
    <p>
      KiSwapProcess(EPROCESS* NewProcess, EPROCESS* OldProcess)
    </p>
    <p>
      {
    </p>
    <p>
      // just reload cr3 and small work with TSS
    </p>
    <p>
      
    </p>
    <p>
      // TSS=KPCR-&gt;TSS;
    </p>
    <p>
      // xor eax,eax
    </p>
    <p>
      // mov gs,ax
    </p>
    <p>
      TSS-&gt;CR3=NewProcess-&gt;DirectoryTableBase;//0x1c
    </p>
    <p>
      // mov cr3,NewProcess-&gt;DirectoryTableBase
    </p>
    <p>
      TSS-&gt;IopmOffset=NewProcess-&gt;IopmOffset;//0x66
    </p>
    <p>
      if(WORD(NewProcess-&gt;LdtDescriptor)==0){lldt 0x00; return;//}
    </p>
    <p>
      //GDT=KPCR-&gt;GDT;
    </p>
    <p>
      (QWORD)GDT-&gt;0x48=(QWORD)NewProcess-&gt;LdtDescriptor;
    </p>
    <p>
      (QWORD)GDT-&gt;0x108=(QWORD)NewProcess-&gt;Int21Descriptor;
    </p>
    <p>
      lldt 0x48;
    </p>
    <p>
      return;
    </p>
    <p>
      }
    </p>
    <p>
      
    </p>
    <p>
      切换进程上下文。正如我所料，这个函数只是重新加载CR3寄存器，再加上一点相关的操作。
    </p>
    <p>
      例如，用IopmOffset域的值建立TSS中的I/O位图的偏移。还必需将选择子的值加载到ldt（只
    </p>
    <p>
      用于VDM session）。
    </p>
    <p>
      
    </p>
    <p>
      /************************* SwapContext ******************************/
    </p>
    <p>
      
    </p>
    <p>
      SwapContext(NextThread,CurThread,WaitIrql)
    </p>
    <p>
      {
    </p>
    <p>
      
    </p>
    <p>
      NextThread.State=ThreadStateRunning; //2
    </p>
    <p>
      KPCR.DebugActive=NextThread.DebugActive;
    </p>
    <p>
      
    </p>
    <p>
      cli();
    </p>
    <p>
      
    </p>
    <p>
      //Save Stack
    </p>
    <p>
      CurThread.KernelStack=esp;
    </p>
    <p>
      
    </p>
    <p>
      //Set stack
    </p>
    <p>
      KPCR.StackLimit=NextThread.StackLimit;
    </p>
    <p>
      KPCR.StackBase=NextThread.InitialStack;
    </p>
    <p>
      
    </p>
    <p>
      tmp=NextThread.InitialStack-0x70;
    </p>
    <p>
      newcr0=cr0&amp;0xfffffff1|NextThread.NpxState|*(tmp+0x6c);
    </p>
    <p>
      if(newcr0!=cr0)reloadcr0();
    </p>
    <p>
      if(!*(tmp-0x1c)&amp;0x20000)tmp-=0x10;
    </p>
    <p>
      TSS=KPCB.TSS;
    </p>
    <p>
      TSS-&gt;ESP0=tmp;
    </p>
    <p>
      
    </p>
    <p>
      //set pTeb
    </p>
    <p>
      KPCB.Self=NextThread.pTeb;
    </p>
    <p>
      esp=NextThread.KernelStack;
    </p>
    <p>
      sti();
    </p>
    <p>
      
    </p>
    <p>
      //correct GDT
    </p>
    <p>
      GDT=KPCB.GDT;
    </p>
    <p>
      WORD(GDT-&gt;0x3a)=NextThread.pTeb;
    </p>
    <p>
      BYTE(GDT-&gt;0x3c)=NextThread.pTeb&gt;&gt;16;
    </p>
    <p>
      BYTE(GDT-&gt;0x3f)=NextThread.pTeb&gt;&gt;24;
    </p>
    <p>
      
    </p>
    <p>
      //if we must swap processes, do it (like KiSwapProcess)
    </p>
    <p>
      
    </p>
    <p>
      if(CurThread.ApcState.Process!=NextThread.ApcState.Process)
    </p>
    <p>
      {
    </p>
    <p>
      //******** like KiSwapProcess
    </p>
    <p>
      }
    </p>
    <p>
      
    </p>
    <p>
      NextThread-&gt;ContextSwitches++;
    </p>
    <p>
      
    </p>
    <p>
      KPCB-&gt;KeContextSwitches++;
    </p>
    <p>
      
    </p>
    <p>
      if(!NextThread-&gt;ApcState.KernelApcPending)return 0;
    </p>
    <p>
      
    </p>
    <p>
      //popf;
    </p>
    <p>
      // jnz HalRequestSoftwareInterrupt// return 0
    </p>
    <p>
      
    </p>
    <p>
      return 1;
    </p>
    <p>
      }
    </p>
    <p>
      
    </p>
    <p>
      切换堆栈，修正GDT，以使FS寄存器指向TEB。如果线程属于当前进程，则不进行上下文切换
    </p>
    <p>
      。否则，进行的操作和KiSwapProcess中的大致差不多。
    </p>
  </div></div></div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68601&quot;)" id="imgN68601"/><img src="12.1.2.5.HookNotity.html_files/icons/button_ok.png" alt="button_ok"/> <a id="FMID_687058286FM"/><div class="nodecontent">ObDereferenceObject</div><div class="content" id="N68601"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1094217962FM"/><div class="nodecontent">
    <p>
      <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/nf-wdm-obdereferenceobject">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/nf-wdm-obdereferenceobject</a>
    </p>
    <h2 id="return-value" style="font-weight: 600; line-height: 1.3; margin-bottom: 12px; margin-top: 32px; font-size: 1.75rem; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-style: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Return Value</font><a class="docon docon-link heading-anchor" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/nf-wdm-obdereferenceobject#return-value" aria-labelledby="return-value" style="color: black; text-decoration: none; font-family: docons; font-size: 0.8em; display: inline-block; font-style: normal; font-weight: 400; font-variant: normal; text-transform: none; text-align: center; line-height: 16px; vertical-align: middle; margin-top: -1px; margin-right: -1px; margin-bottom: -1px; margin-left: -1px; border-top-style: none; border-top-width: 0px; border-right-style: none; border-right-width: 0px; border-bottom-style: none; border-bottom-width: 0px; border-left-style: none; border-left-width: 0px; height: 1px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; width: 1px"><font color="black" face="docons" size="0.8em">
</font></a>    </h2>
    <p class="" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <strong style="font-weight: 600"><b><font size="3">ObDereferenceObject</font></b></strong><font size="3"> returns a value that is reserved for system use. Drivers must treat this value as VOID</font>
    </p>
    <h2 id="remarks" class="" style="font-weight: 600; line-height: 1.3; margin-bottom: 12px; margin-top: 32px; font-size: 1.75rem; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-style: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">Remarks</font><a class="docon docon-link heading-anchor" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/nf-wdm-obdereferenceobject#remarks" aria-labelledby="remarks" style="color: black; text-decoration: none; font-family: docons; font-size: 0.8em; display: inline-block; font-style: normal; font-weight: 400; font-variant: normal; text-transform: none; text-align: center; line-height: 16px; vertical-align: middle; margin-top: -1px; margin-right: -1px; margin-bottom: -1px; margin-left: -1px; border-top-style: none; border-top-width: 0px; border-right-style: none; border-right-width: 0px; border-bottom-style: none; border-bottom-width: 0px; border-left-style: none; border-left-width: 0px; height: 1px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; width: 1px"><font color="black" face="docons" size="0.8em">
</font></a>    </h2>
    <p class="" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <b style="font-weight: 600"><font size="3">ObDereferenceObject</font></b><font size="3"> decreases the reference count of an object by one. If the object was created as temporary (the OBJ_PERMANENT flag was not specified on creation), and the reference count reaches zero, the object can be deleted by the system. </font>
    </p>
    <p class="x-hidden-focus" style="margin-top: 0; margin-bottom: 0px; color: rgb(0, 0, 0); font-family: Segoe UI, SegoeUI, Segoe WP, Helvetica Neue, Helvetica, Tahoma, Arial, sans-serif; font-size: 16px; font-style: normal; font-weight: 400; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; background-color: rgb(255, 255, 255)">
      <font size="3">A driver can delete a temporary object it created by decreasing its reference count to zero. A driver must never attempt to delete an object it did not create.</font>
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_510838447FM"/><div class="nodecontent">
    <p>
      参考:
    </p>
    <p>
      <a href="https://www.cnblogs.com/guanlaiy/archive/2013/02/18/2915332.html">https://www.cnblogs.com/guanlaiy/archive/2013/02/18/2915332.html</a>
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      //凡是调用了Reference系列的函数都要通过调用ObDereferenceObject来解除引用
    </p>
    <p>
      
    </p>
    <p>
      [popexizhi: 这里的
    </p>
    <p>
          ObDereferenceObject(pTargetThread);
    </p>
    <p>
      pTargetThread 的创建来自于
    </p>
    <p>
      ObReferenceObjectByHandle(ThreadHandle,THREAD_ALL_ACCESS,PsThreadType,KernelMode,&amp;pTargetThread,NULL);
    </p>
    <p>
      所以要调用这个
    </p>
    <p>
      
    </p>
    <p>
      ]
    </p>
  </div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68774&quot;)" id="imgN68774"/><a id="FMID_1373676220FM"/><div class="nodecontent">[go]list:</div><div class="content" id="N68774"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68781&quot;)" id="imgN68781"/><a id="FMID_1315031202FM"/><div class="nodecontent">[thinking] note how  to be better for list</div><div class="content" id="N68781"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68787&quot;)" id="imgN68787"/><a id="FMID_986926267FM"/><div class="nodecontent">
    <p>
      [popexizhi：
    </p>
    <p>
      感觉这个就ok，可以类比:http://xuyafei.cn/post/public/codeguide2-typesetting
    </p>
    <p>
      - 目录
    </p>
    <p>
      - code 分割 [是否找可以通用的css做模板内嵌]
    </p>
    <p>
      - 分标题
    </p>
    <p>
      - 如果没有好的方向可以类比上面的地址，想想还有什么
    </p>
    <p>
      ]
    </p>
  </div><div class="content" id="N68787"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_496852701FM"/><div class="nodecontent">[next]blog目录如何构建</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1786638920FM"/><div class="nodecontent">[next] code分割的css如何</div></div></div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68839&quot;)" id="imgN68839"/><a id="FMID_1139484812FM"/><div class="nodecontent">ps: sys 编译问题</div><div class="content" id="N68839"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1434038857FM"/><div class="nodecontent">
    <p>
      [popexizhi:拖了一个国内的假期，发现自己这个是编译不了的要求使用sys环境，本来想放弃直接只看代码的，但是看看后面的章节多是sys的使用，好吧既然要看就要有效的原则，pope打算正好一试愿力之与技术的使用到底可以有几分，开始继续，
    </p>
    <ol>
      <li>
        how to build sys
      </li>
      <li>
        sys 后如何使用？
      </li>
      <li>
        or 如何加载已有project build for use ?
      </li>
    </ol>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      ]
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68888&quot;)" id="imgN68888"/><a id="FMID_1577298351FM"/><div class="nodecontent">ddk</div><div class="content" id="N68888"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68894&quot;)" id="imgN68894"/><a id="FMID_191842026FM"/><div class="nodecontent">build env 区别</div><div class="content" id="N68894"><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68900&quot;)" id="imgN68900"/><a id="FMID_1018395536FM"/><div class="nodecontent">checked build 与 free build</div><div class="content" id="N68900"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_29516030FM"/><div class="nodecontent">参考:http://smilejay.com/2012/03/windows_chk_fre/</div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1791481968FM"/><div class="nodecontent"/></div></div></div></div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68921&quot;)" id="imgN68921"/><a id="FMID_706036167FM"/><div class="nodecontent">build - ps</div><div class="content" id="N68921"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1179893128FM"/><div class="nodecontent">
    <p>
      [pass]
    </p>
    <p>
      错误:1&gt;c:\winddk\7600.16385.1\inc\ddk\ntifs.h(85) : error C2371: 'PEPROCESS' : redefi
    </p>
    <p>
      nition; different basic types
    </p>
    <p>
      
    </p>
    <p>
      参考:https://blog.csdn.net/ytfrdfiw/article/details/23334297
    </p>
    <p>
      <font color="rgb(79, 79, 79)" face="Microsoft YaHei, SF Pro Display, Roboto, Noto, Arial, PingFang SC, sans-serif">解决方法是先include ntifs.h，然后再include ntddk.h，就可以解决</font>
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_244783813FM"/><div class="nodecontent">
    <p>
      [next]
    </p>
    <p>
      错误:1&gt;c:\test\2hith\accommon.h(446) : error C2061: syntax error : identifier 'SERVICE_DESCRIPTOR_TABLE'
    </p>
  </div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_906923964FM"/><div class="nodecontent">[popexizhi: 这个问题现在把pope 困住了，作为一个问题先保留下来，当前自己停止的位置就是上面这个build无法成功，使用给的工具也无法成功。新项目加入旧的文件后编译还是提示有冲突的定义。]</div></div></div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N68998&quot;)" id="imgN68998"/><a id="FMID_569456552FM"/><div class="nodecontent">[popexizhi analysis]</div><div class="content" id="N68998"><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1758227337FM"/><div class="nodecontent">
    <p>
      对选择NtResumeThread hook的原因
    </p>
    <p>
      多数文章都分析如下，进程创建过程中CreateProcess的调用过程解剖如下:
    </p>
    <p>
      CreateProcess -&gt;
    </p>
    <p>
      CreateProcessInternal -&gt;
    </p>
    <p>
      NtCreateProcess -&gt; -&gt;
    </p>
    <p>
      NtCreateThread -&gt;
    </p>
    <p>
      NtResumeThread
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
    <p>
      https://blog.csdn.net/zhou191954/article/details/10164459
    </p>
    <p>
      推荐的阅读-分析系统创建进程过程，寻找方法
    </p>
    <p>
      关于这方面内容，可以参考毛德操老师的两篇文章
    </p>
    <p>
      《漫谈兼容内核之十七:再谈Windows的进程创建》
    </p>
    <p>
      《漫谈兼容内核之二十二:Windows线程的调度和运行》
    </p>
    <p>
      
    </p>
    <p>
      
    </p>
  </div></div><div class="node"><img src="12.1.2.5.HookNotity.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1052601621FM"/><div class="nodecontent">
    <p>
      此方式的做法是
    </p>
    <p>
      通过对系统服务NtResumeThread的注入，查找其中notepad.exe的对这个系统方法的调用，在这个调用中对notepad的进程插入Shellcode并修改CONTEXT，当notepad的对应线程恢复时就先执行这个ShellCode
    </p>
    <p>
      
    </p>
    <p>
      这里NtResumeThread是系统提供的在线程刚刚创建或被暂停时一定使用的内核服务；
    </p>
    <p>
      而原始code中对于Shellcode的插入点选择eax而不是eip的原因也是和这个NtResumeThread的使用场景直接相关的，虽然pope现在也没找到code上的直接证据，但是从逻辑上分析应该是这样的。
    </p>
    <p>
      
    </p>
    <p>
      原书在code后的追加说当前方法在x64平台上的内核PatchGuard机制导致不可以用，不过pope好像x32平台也没有编译通过：）
    </p>
    <p>
      这个方式和4.SetThreadContext法是相似的都是在系统中的对进程管理涉及到的某个位置进行修改，之后被执行shellcode。
    </p>
  </div></div></div></div></div></div>
</body></html>